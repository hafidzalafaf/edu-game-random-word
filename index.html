<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Drag Race Susun Kata â€” 2 Tim</title>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <h1>ğŸ Ayo Susun Kata</h1>

        <div class="topbar">
            <button id="startBtn">Mulai Game</button>
        </div>

        <div class="skor-wrap">
            <div class="skor-card"><span>Skor</span><strong id="scoreLeft">0</strong></div>

            <div class="round-wrap">
                <span>Soal</span>
                <strong id="roundLabel">0</strong>
            </div>

            <div class="skor-card"><span>Skor</span><strong id="scoreRight">0</strong></div>
        </div>

        <div class="arena">
            <!-- Tim Upin -->
            <div class="player" id="playerLeft">
                <div class="title">ğŸ‘ˆ Tim Upin</div>
                <div class="status" id="statusLeft">Siap</div>

                <div class="target" id="slotsLeft"></div>

                <div class="letters" id="lettersLeft"></div>
                <button class="reset-btn" onclick="resetTim('left')">Reset Jawaban</button>
            </div>

            <!-- Tim Ipin -->
            <div class="player" id="playerRight">
                <div class="title">Tim Ipin ğŸ‘‰</div>
                <div class="status" id="statusRight">Siap</div>

                <div class="target" id="slotsRight"></div>

                <div class="letters" id="lettersRight"></div>
                <button class="reset-btn" onclick="resetTim('right')">Reset Jawaban</button>
            </div>
        </div>

        <div style="text-align: center; margin-top: 18px">
            <div id="winnerBanner" class="winner"></div>
        </div>

        <div id="finalModal" class="modal hidden">
            <div class="modal-content">
                <h2 id="finalTitle">ğŸ‰ Permainan Selesai!</h2>
                <p id="finalWinner"></p>
                <button id="closeModal">Main Lagi</button>
            </div>
        </div>

        <audio id="correctSound" src="./assets/answer-correct.mp3"></audio>
        <audio id="winSound" src="./assets/win-sound.mp3"></audio>

        <script>
            /* ------- DATA dan STATE ------- */
            const WORDS = [
                'bunga',
                'sungai',
                'rumah',
                'meja',
                'kursi',
                'kucing',
                'sekolah',
                'matahari',
                'pelangi',
                'harimau',
                'pisang',
                'hujan',
                'awan',
                'daun',
                'bulan',
                'kita',
                'guru',
                'anak',
                'laut',
                'bintang',
            ]

            let currentWord = ''
            let round = 0
            let scoreLeft = 0
            let scoreRight = 0
            let winnerDeclared = false
            let questionPool = []

            /* ------- HELPERS ------- */
            function shuffleArray(a) {
                a = a.slice()
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1))
                    ;[a[i], a[j]] = [a[j], a[i]]
                }
                return a
            }

            function scramble(word) {
                const letters = word.split('')
                let scr = shuffleArray(letters)
                for (let i = 0; i < 6 && scr.join('') === word; i++) {
                    scr = shuffleArray(letters)
                }
                return scr
            }

            /* ------- RENDER ------- */

            function createWordLabel(side) {
                const labelId = side === 'left' ? 'wordLabelLeft' : 'wordLabelRight'
                let lbl = document.getElementById(labelId)
                if (!lbl) {
                    lbl = document.createElement('div')
                    lbl.id = labelId
                    lbl.style.fontSize = '24px'
                    lbl.style.fontWeight = '700'
                    lbl.style.marginBottom = '10px'
                    lbl.style.letterSpacing = '4px'
                    lbl.style.color = '#333'
                    document
                        .getElementById(side === 'left' ? 'playerLeft' : 'playerRight')
                        .insertBefore(
                            lbl,
                            document.getElementById(side === 'left' ? 'slotsLeft' : 'slotsRight'),
                        )
                }
                lbl.textContent = currentWord.toUpperCase()
            }

            function createSlots(container, length, side) {
                container.innerHTML = ''
                for (let i = 0; i < length; i++) {
                    const slot = document.createElement('div')
                    slot.className = 'slot'
                    slot.dataset.index = i
                    slot.dataset.side = side
                    slot.addEventListener('dragover', e => e.preventDefault())
                    slot.addEventListener('drop', handleDrop)
                    slot.addEventListener('click', () => handleSlotClick(slot))
                    container.appendChild(slot)
                }
            }

            function createTiles(container, letters, side) {
                container.innerHTML = ''
                letters.forEach((ch, idx) => {
                    const t = document.createElement('div')
                    t.className = 'tile'
                    t.draggable = true
                    t.textContent = ch.toUpperCase()
                    t.dataset.letter = ch.toUpperCase()
                    t.dataset.side = side
                    t.dataset.origIndex = idx
                    t.addEventListener('dragstart', handleDragStart)
                    t.addEventListener('click', () => handleTileClick(t))
                    container.appendChild(t)
                })
            }

            function setStatus(side, text) {
                document.getElementById(
                    side === 'left' ? 'statusLeft' : 'statusRight',
                ).textContent = text
            }

            function updateScoreUi() {
                document.getElementById('scoreLeft').textContent = scoreLeft
                document.getElementById('scoreRight').textContent = scoreRight
                document.getElementById('roundLabel').textContent = round
            }

            function showWinner(text) {
                document.getElementById('winnerBanner').textContent = text
                winnerDeclared = true
            }

            /* ------- DRAG & CLICK LOGIC ------- */
            let dragData = null

            function handleDragStart(e) {
                dragData = {
                    elem: e.target,
                    side: e.target.dataset.side,
                    letter: e.target.dataset.letter,
                }
                e.dataTransfer.setData('text/plain', JSON.stringify(dragData))
            }

            function handleDrop(e) {
                e.preventDefault()
                const slot = e.currentTarget
                let data = dragData

                try {
                    if (!data) data = JSON.parse(e.dataTransfer.getData('text/plain'))
                } catch {}

                if (!data || data.side !== slot.dataset.side) return
                if (slot.dataset.filled === 'true') return

                placeLetterToSlot(data.elem, slot)
            }

            function placeLetterToSlot(tile, slot) {
                slot.textContent = tile.dataset.letter
                slot.dataset.filled = 'true'
                slot.dataset.letter = tile.dataset.letter

                tile.style.visibility = 'hidden'
                tile.setAttribute('draggable', 'false')
                tile.dataset.placed = 'true'

                checkComplete(slot.dataset.side)
            }

            function handleTileClick(tile) {
                if (tile.dataset.placed === 'true') return
                const side = tile.dataset.side
                const slots = Array.from(document.querySelectorAll(`.slot[data-side="${side}"]`))
                const empty = slots.find(s => s.dataset.filled !== 'true')
                if (empty) placeLetterToSlot(tile, empty)
            }

            function handleSlotClick(slot) {
                if (slot.dataset.filled === 'true') {
                    const side = slot.dataset.side
                    const tile = Array.from(
                        document.querySelectorAll(`.tile[data-side="${side}"]`),
                    ).find(
                        t =>
                            t.dataset.letter === slot.dataset.letter && t.dataset.placed === 'true',
                    )

                    if (tile) {
                        tile.style.visibility = 'visible'
                        tile.dataset.placed = 'false'
                        tile.setAttribute('draggable', 'true')
                    }

                    slot.textContent = ''
                    delete slot.dataset.filled
                    delete slot.dataset.letter
                }
            }

            /* ------- CHECKING ------- */

            function getCurrentAttempt(side) {
                const slots = Array.from(document.querySelectorAll(`.slot[data-side="${side}"]`))
                return slots.map(s => s.dataset.letter || '').join('')
            }

            function resetTim(side) {
                const slots = document.getElementById(side === 'left' ? 'slotsLeft' : 'slotsRight')
                const letters = document.getElementById(
                    side === 'left' ? 'lettersLeft' : 'lettersRight',
                )

                createSlots(slots, currentWord.length, side)
                createTiles(letters, scramble(currentWord), side)
            }

            function checkComplete(side) {
                if (winnerDeclared) return

                const attempt = getCurrentAttempt(side)

                if (attempt.length !== currentWord.length) return

                // BENAR â†’ menang
                if (attempt === currentWord.toUpperCase()) {
                    playCorrectSound()
                    showWinner(side === 'left' ? 'ğŸ† Tim Upin MENANG!' : 'ğŸ† Tim Ipin MENANG!')
                    if (side === 'left') scoreLeft += 5
                    else scoreRight += 5
                    updateScoreUi()
                    disableAllTiles()

                    // â­ï¸ otomatis lanjut ke soal berikutnya
                    setTimeout(() => {
                        startRound()
                    }, 1000)

                    return
                }

                // âŒ SALAH â†’ reset otomatis
                setStatus(side, 'Salah! Mengulang...')
                setTimeout(() => {
                    setStatus(side, 'Coba lagi!')
                    resetTim(side)
                }, 600)
            }

            /* ------- UTILITY ------- */

            function disableAllTiles() {
                document.querySelectorAll('.tile').forEach(t => {
                    t.setAttribute('draggable', 'false')
                    t.style.cursor = 'default'
                })
            }

            function enableAllTiles() {
                document.querySelectorAll('.tile').forEach(t => {
                    if (t.dataset.placed !== 'true') {
                        t.setAttribute('draggable', 'true')
                        t.style.visibility = 'visible'
                        t.style.cursor = 'grab'
                    } else {
                        t.setAttribute('draggable', 'false')
                        t.style.visibility = 'hidden'
                    }
                })
            }

            /* ------- GAME FLOW ------- */

            function startRound() {
                winnerDeclared = false
                round++

                if (round > questionPool.length) {
                    showFinalModal()
                    return
                }
                currentWord = questionPool[round - 1]

                document.getElementById('winnerBanner').textContent = ''

                createWordLabel('left')
                createWordLabel('right')

                createSlots(document.getElementById('slotsLeft'), currentWord.length, 'left')
                createSlots(document.getElementById('slotsRight'), currentWord.length, 'right')

                createTiles(document.getElementById('lettersLeft'), scramble(currentWord), 'left')
                createTiles(document.getElementById('lettersRight'), scramble(currentWord), 'right')

                setStatus('left', 'Susun kata!')
                setStatus('right', 'Susun kata!')

                updateScoreUi()
                enableAllTiles()
            }

            /* ------- BUTTON EVENTS ------- */
            document.getElementById('startBtn').addEventListener('click', () => {
                prepareQuestions()
                round = 0
                startRound()
            })

            // document.getElementById('nextBtn').addEventListener('click', startRound)

            // document.getElementById('resetBtn').addEventListener('click', () => {
            //     round = 0
            //     scoreLeft = 0
            //     scoreRight = 0
            //     winnerDeclared = false

            //     document.getElementById('winnerBanner').textContent = ''
            //     document.getElementById('slotsLeft').innerHTML = ''
            //     document.getElementById('slotsRight').innerHTML = ''
            //     document.getElementById('lettersLeft').innerHTML = ''
            //     document.getElementById('lettersRight').innerHTML = ''

            //     setStatus('left', 'Siap')
            //     setStatus('right', 'Siap')
            //     updateScoreUi()
            // })
            document.getElementById('closeModal').addEventListener('click', () => {
                console.log('TEST')

                document.getElementById('finalModal').classList.add('hidden')

                round = 0
                scoreLeft = 0
                scoreRight = 0
                updateScoreUi()
                prepareQuestions()
                startRound()
            })

            document.addEventListener('dragend', () => (dragData = null))
            document.addEventListener('mouseup', () => (dragData = null))

            updateScoreUi()

            function playCorrectSound() {
                const audio = document.getElementById('correctSound')
                audio.currentTime = 0
                audio.play()
            }

            function prepareQuestions() {
                const shuffled = shuffleArray(WORDS)
                questionPool = shuffled.slice(0, 20).map(w => w.toUpperCase())
            }

            function playWinSound() {
                const audio = document.getElementById('winSound')
                audio.currentTime = 0
                audio.play()
            }

            function showFinalModal() {
                // Tentukan siapa pemenang
                let winnerText = ''
                if (scoreLeft > scoreRight) winnerText = 'ğŸ† Pemenang: Tim Upin!'
                else if (scoreRight > scoreLeft) winnerText = 'ğŸ† Pemenang: Tim Ipin!'
                else winnerText = 'ğŸ¤ Seri! Kedua pemain sama kuat!'

                document.getElementById('finalWinner').textContent = winnerText

                // Tampilkan modal
                document.getElementById('finalModal').classList.remove('hidden')

                playWinSound()
            }
        </script>
    </body>
</html>
